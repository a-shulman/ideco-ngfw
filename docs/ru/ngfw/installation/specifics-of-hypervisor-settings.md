# Настройка гипервизора

{% note warning %}

Для установки Ideco NGFW нужно включить режим UEFI в настройках виртуальной машины.

{% endnote %}

{% note info %}

**Обязательные условия для работы Ideco NGFW:**

* Поддержка UEFI;
* Отключить режим Legacy загрузки (он также может называться CSM);
* Отключить опцию Secure Boot в UEFI.

{% endnote %}

Ideco NGFW поддерживает работу на следующих гипервизорах:

* VMware (Workstation и ESXi) версии не ниже 6.5.0;
* Microsoft Hyper-V (2-го поколения);
* VirtualBox версии не ниже 7.0.0;
* KVM версии не ниже 1.2.0;
* Citrix XenServer.

## Общие рекомендации

* Тип ОС для создания виртуальной машины: **Linux Fedora 64 bit**;
* Минимальный размер жесткого диска: **150 ГБ**;
* Минимальное количество оперативной памяти: **16 ГБ**;
* Внутренние часы ВМ должны быть настроены на хранение времени во временной зоне UTC.

{% note warning %}

Если при установке Ideco NGFW появилась ошибка с текстом **Требуется не менее 16 ГБ оперативной памяти** и при этом указан рекомендуемый размер оперативной памяти, то уменьшите размер ресурсов, выделенных под видеопамять, до минимального.

{% endnote %}

{% note info %}

Если при установке Ideco NGFW появилось окно с надписью **Installation in BIOS mode is not supported**, проверьте включение режима UEFI в настройках виртуальной машины. 

{% endnote %}

## Microsoft Hyper-V 

* Поддерживается только второе поколение виртуальных машин под Windows Server 2012 R2 или выше; 
* Отключите опцию **Secure Boot** (безопасная загрузка);
* Используйте обычный виртуальный сетевой адаптер (Network Adapter).

**Видеоинструкция по настройке виртуальной машины**:

{% embed url="https://rutube.ru/video/63e3d7a8e65cb9c1a55a32948095a6a4/

<!-- https://rutube.ru/video/63e3d7a8e65cb9c1a55a32948095a6a4/ -->

## VMware ESXi 6.7

* Перед установкой Ideco NGFW увеличьте размер видеопамяти для виртуальной машины до 16 МБ;
* Используйте виртуальные сетевые адаптеры **vmxnet3**.

{#top}

{% cut "Настройка" %}

Перед установкой Ideco NGFW загрузите образ, скачанный с [MY.IDECO](https://my.ideco.ru/), на VMware ESXi. При настройке виртуальной машины потребуется указать его путь.

1. Создайте виртуальную машину:

    ![](../../_images/setup-hypervisor4.png)

2. Укажите **Имя** виртуальной машине и установите остальные настройки как на скриншоте:

    ![](../../_images/setup-hypervisor5.png)

3. Выберите хранилище для виртуальной машины:

    ![](../../_images/setup-hypervisor6.png)

4. Установите размер оперативной памяти **16ГБ** и размер диска **150ГБ**. После выберите в поле **CD/DVD Drive** Datastore ISO file и укажите путь к загрузочному образу:
   
    ![](../../_images/setup-hypervisor7.png)

5. Включите **UEFI** на вкладке **VM Options**, выбрав в поле **Firmware** EFI:

    ![](../../_images/setup-hypervisor8.png)

6. Нажмите **Finish**:

    ![](../../_images/setup-hypervisor9.png)

{% endcut %}

{% note info %}

При установке Ideco NGFW на хосты кластера с разными поколениями процессоров укажите в настройках EVC самое старое поколение процессора из хостов, соответствующее минимальным системным требованиям для установки.

{% endnote %}

## VMware Workstation 17.0

* Перед установкой Ideco NGFW увеличьте размер видеопамяти для виртуальной машины до 16 МБ;
* Используйте виртуальные сетевые адаптеры **vmxnet3**.

{#top}

{% cut "Настройка" %}

1. Создайте виртуальную машину, нажав **Create a New Virtual Machine**:

    ![](../../_images/setup-hypervisor12.png)

2. Укажите загрузочный ISO-образ:

    ![](../../_images/setup-hypervisor13.png)

3. Выберите гостевую операционную систему **Linux** и в раскрывающемся списке укажите тип **Fedora 64-bit**:

    ![](../../_images/setup-hypervisor14.png)

4. Укажите имя виртуальной машины и директорию для создания виртуального диска:

    ![](../../_images/setup-hypervisor15.png)

5. Укажите размер вирутального жесткого диска **150ГБ**:
   
   ![](../../_images/setup-hypervisor16.png)

6. Выберите **Customize Hardware** для изменения настроек виртуальной машины:

   ![](../../_images/setup-hypervisor17.png)

7. Укажите размер виртуальной оперативной памяти **16384МБ**:

   ![](../../_images/setup-hypervisor18.png)

8. Укажите количество ядер процесса равное 4:

   ![](../../_images/setup-hypervisor19.png)

9. Выйдите из меню и нажмите **Finish** для окончания настройки:

   ![](../../_images/setup-hypervisor20.png)

10. Перейдите в окно виртуальной машины и нажмите **Edit virtual machine settings**:

   ![](../../_images/setup-hypervisor21.png)

11. Перейдите во вкладку **Options**:

   ![](../../_images/setup-hypervisor22.png)

12. Выберите опцию **Advanced** и установите для параметра Firmware Type значение **UEFI**:

   ![](../../_images/setup-hypervisor23.png)

13. Нажмите **OK** для завершения настройки виртуальной машины.

{% endcut %}

## Citrix XenServer

{#top}

{% cut "Настройка" %}

Если xenserver не загружается с установочного образа:

1. Выполните команду `xe vm-list`. Она отобразит список виртуальных машин на xenserver;
2. Выберите виртуальную машину с NGFW и запомните ее UUID;
3. Выполните команду:
``` 
xe vm-param-set uuid=<UUID> HVM-boot-policy=BIOS\ order HVM-boot-params:order=dc
```

После 3 шага начнется загрузка с установочного носителя.

{% endcut %}

## VirtualBox 7.0.12
* По умолчанию при создании виртуальной машины создается 1 сетевая карта с типом подключения **NAT**.

{#top}

{% cut "Настройка" %}

1. Укажите **Имя** виртуальной машины (ВМ), выберите директорию для ВМ и установите путь до загрузочного образа NGFW. Остальные параметры установите как на скриншоте:

    ![](../../_images/setup-hypervisor1.png)

2. Установите размер оперативной памяти ВМ (**16 ГБ**) и нажмите **Включить EFI**:
    
    ![](../../_images/setup-hypervisor2.png)

3. Cоздайте виртуальный жесткий диск под ВМ (Объем не меньше **150ГБ**):

    ![](../../_images/setup-hypervisor3.png)

4. Нажмите **Готово**

{% endcut %}

## KVM

{#top}

{% cut "Настройка" %}

1. При установке Ideco NGFW выберите тип операционной системы - **Fedora**

2. На пятом шаге (virtm-manager) установки обязательно поставьте галочку **Проверить конфигурацию перед установкой** и нажмите кнопку **Готово**.

    ![](../../_images/setup-hypervisor10.png)

3. Для дисков и сетевых карт измените интерфейс на **virtio.**

4. Для дисков используйте режим кеширования **writeback**, если диски хранятся в qcow2 или raw-файлах.\
Если нет - проконсультируйтесь у администратора хранилища или нашей технической поддержки относительно выбора режима кеширования.

5. В появившемся окне на вкладке **Обзор** в поле Firmware выберите пункт **UEFI x86\_64:/usr/share/OVMF/OVMF\_CODE.fd**. Выбор этого пункта включит **UEFI** и выключит опцию **Secure Boot**.

    ![](../../_images/setup-hypervisor11.png)

Если пункта **UEFI x86\_64:/usr/share/OVMF/OVMF\_CODE.fd** нет в списке, доустановите пакет ovmf. В Ubuntu этот пакет устанавливается командой `sudo apt install ovmf`.

{% endcut %}

Далее начнется установка Ideco NGFW на виртуальную машину. Подробнее об установке в статье [Установка](installation-process.md)

{% note info %}

При возможных проблемах проверьте соответствие параметров виртуальной машины [общим рекомендациям](#obshie-rekomendacii).

{% endnote %}


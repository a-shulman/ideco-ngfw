# Инструкция по созданию подключения в Mac OS

{% note info %}

Перед настройкой VPN-подключения перейдите в раздел **Пользователи -> VPN-подключения -> Доступ по VPN** и создайте разрешающее VPN-подключение правило.

{% endnote %}

{% note warning %}

Не рекомендуем использовать для VPN-подключений кириллические логины.

{% endnote %}

{% note info %}

При проблемах с подключением на IOS требуется:

1\. Проверить, что в качестве VPN-сервера указано его доменное имя в разделе **Пользователи -> VPN-подключения**.

2\. Проверить, что на доменное имя VPN-сервера выдан сертификат Let's Encrypt.

{% endnote %}

{#top}

{% cut "Протокол PPPoE" %}

Для настройки Ideco NGFW перейдите в раздел **Пользователи -> VPN-подключение -> Основное** и установите флаг **Подключение по PPPoE**:

![](../../../../_images/pppoe.png)

**Создание подключения в MacOS**

1\. Перейдите в раздел **Системные настройки -> Сеть**;

2\. Нажмите **Добавить** в левом нижнем углу (иконка ![](../../../../_images/macos2.png));

3\. В появившемся окне заполните:

* **Интерфейс** - PPPoE;
* **Ethernet** - например, Wi-Fi;
* **Имя службы** - имя подключения.

<img src="/../_images/macos8.png" alt="" data-size="original">

4\. Нажмите **Создать** и заполните:

* **Имя службы PPPoE** - имя службы;
* **Имя учетной записи** - логин;
* **Пароль** - пароль.

<img src="/../_images/macos9.png" alt="" data-size="original">

5\. Нажмите **Подключить**.

{% endcut %}

{#top}

{% cut "Протокол IKEv2/IPsec" %}

**Настройка Ideco NGFW:**

1\. Перейдите в раздел **Пользователи -> VPN-подключение -> Основное**.

2\. Установите флаг **Подключение по IKEv2/IPsec** и заполните поля **Домен**:

<img src="/../_images/ipsec-ikev2-9-11.png" alt="" data-size="original">

3\. Скачайте корневой сертификат Ideco NGFW в разделе **Сервисы -> Сертификаты -> Загруженные сертификаты** в веб-интерфейсе NGFW или в личном кабинете пользователя по кнопке **Скачать корневой сертификат**.

Корневой сертификат потребуется для настройки подключения рабочей станции пользователя, если не был получен корневой сертификат через Let\`s Encrypt. При необходимости перенесите файл сертификата на рабочую станцию.\
Если для VPN-подключения используется сертификат, выданный Let\`s Encrypt, то установка корневого сертификата на устройство не требуется.

**Создание подключения в MacOS:**

1\. Перейдите в раздел **Системные настройки -> Сеть**.

2\. Нажмите **Добавить** в левом нижнем углу (иконка ![](../../../../_images/icon-add.png)).

3\. Заполните поля:

* **Интерфейс** - VPN;
* **Тип VPN** - IKEv2;
* **Имя службы** - имя подключения.

<img src="/../_images/macos7.png" alt="" data-size="original">

4\. Нажмите **Создать**;

5\. Установите параметры подключения:

* **Адрес сервера** - адрес VPN-сервера;
* **Удаленный ID** - продублируйте адрес VPN-сервера.

<img src="/../_images/macos11.png" alt="" data-size="original">

6\. Выберите **Настройки аутентификации**.

7\. Укажите идентификационные данные и нажмите **OK**:

* **Имя пользователя** - имя пользователя, которому разрешено подключение по VPN;
* **Пароль** - пароль пользователя.

<img src="/../_images/macos12.png" alt="" data-size="original">

8\. Нажмите **ОК**.

9\. Поставьте флаг в пункте **Показывать статус VPN в строке меню**, нажмите **Применить**  и включите соединение.

{% endcut %}

{#top}

{% cut "Протокол SSTP" %}

**Настройка Ideco NGFW:**

1\. Перейдите в раздел **Пользователи -> VPN-подключения -> Основное**.

2\. Установите флаг **Подключение по SSTP** и заполните поля **Домен** и **Порт**:

![](../../../../_images/vpn-authorization5.png)

3\. Скачайте корневой сертификат Ideco NGFW в разделе **Сервисы -> Сертификаты -> Загруженные сертификаты** в веб-интерфейсе NGFW или в личном кабинете пользователя по кнопке **Скачать корневой сертификат**.

Корневой сертификат потребуется для настройки подключения рабочей станции пользователя, если не был получен корневой сертификат через Let\`s Encrypt. При необходимости перенесите файл сертификата на рабочую станцию.\
Если для VPN-подключения используется сертификат, выданный Let\`s Encrypt, то установка корневого сертификата на устройство не требуется.

**Создание подключения в MacOS:**

1\. Откройте терминал и установите `sstp-client`, выполнив команды:

```
brew update
brew install sstp-client
```

2\. Создайте и включите SSTP-подключение командой:

```
sudo /usr/local/sbin/sstpc --cert-warn --tls-ext --user <логин пользователя Ideco NGFW> --password <Пароль пользователя Ideco NGFW> <домен:порт> usepeerdns require-mschap-v2 noauth noipdefault noccp refuse-eap refuse-pap refuse-mschap defaultroute
```

* Если указан параметр `defaultroute`, в VPN-туннель будет заворачиваться весь трафик. 
* Чтобы через VPN-туннель проходил только трафик до определенных сетей, используйте параметр `nodefaultroute` и добавьте маршруты в таблицу машрутизации вкручную, например: `sudo route add -net "172.16.0.0/12" -interface ppp0`.

3\. Для проверки подключения откройте новую вкладку или окно терминала и введите команду `ifconfig -a`. Если в выводе присутствует строка вида `ppp0: flags=8051 mtu 1500 inet 10.128.0.0 –> 10.128.0.1 netmask 0xff000000`, подключение установлено.

4\. Чтобы отключить соединение, перейдите в терминал, из которого оно было установлено, и нажмите **Ctrl+C**.

{% endcut %}

{#top}

{% cut "Протокол L2TP/IPsec" %}

**Важно:** L2TP IPsec-клиенты, находящиеся за одним NAT'ом, могут испытывать проблемы подключения, если их более одного. Рекомендуем вместо L2TP IPsec использовать IKEv2 IPsec.

**Настройка Ideco NGFW:**

1\. Перейдите в раздел **Пользователи -> VPN-подключение -> Основное**.

2\. Установите флаг **Подключение по L2TP/IPsec** и скопируйте **PSK**-ключ:

<img src="/../_images/l2tp-on.png" alt="" data-size="original">

**Создание подключения в MacOS:**

1\. Перейдите в раздел **Системные настройки -> Сеть** и нажмите **Добавить** в левом нижнем углу.

<img src="/../_images/macos.png" alt="" data-size="original">

2\. В появившемся окне заполните:

* **Интерфейс** - VPN;
* **Тип VPN** - L2TP через IPsec;
* **Имя службы** - имя подключения.

<img src="/../_images/macos1.png" alt="" data-size="original">

3\. Нажмите **Создать**.

4\. Заполните **Адрес сервера** и **Имя учетной записи**:

<img src="/../_images/macos3.png" alt="" data-size="original">

5\. Поставьте флаг на пункте **Показывать статус VPN в строке меню** и выберите **Настройки аутентификации**.

6\. В **Аутентификации пользователя** заполните **Пароль**, в **Аутентификации компьютера** - **Общий ключ (Shared Secret)**:

<img src="/../_images/macos4.png" alt="" data-size="original">

7\. Нажмите **ОК -> Применить** и включите соединение.

{% endcut %}

